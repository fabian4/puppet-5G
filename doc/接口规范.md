# 硬核桃 5G 平台 接口规范

> 整理于《中国电信-中国联通 5G 消息业务平台行业客户接入接口技术规范 V1.0.4》

## 一、接口目录

1. [基础能力接口](#)



## 二、参数说明

### 1. url参数说明

| 序号 | 字段       | 数据类型 | 可选属性 | 描述                                                         |
| ---- | ---------- | -------- | -------- | ------------------------------------------------------------ |
| 1    | severRoot  | string   | 必选     | 服务器基础URL: hostname+port+base <br />Port和base path可选<br />例: example.com/exampleAPI |
| 2    | apiVersion | string   | 必选     | 客户端想使用的API版本号 <br />例: "v1"                       |
| 3    | chatbotId  | string   | 必选     | 行业消息的统一服务地址(Chatbot接 入号)，客户端可根据此地址将所有通 知集合展现。 |

### 2. 请求头参数

| 序号 | 字段           | 数据类型 | 可选属性                  | 描述                                                         |
| ---- | -------------- | -------- | ------------------------- | ------------------------------------------------------------ |
| 1    | authorization  | string   | 必选（除获取accessToken） | 调用接口凭证<br />例：accessToken TXlwdndOZG0yWTpjUml0dHMzM1dKRnBXRUdD |
| 2    | content-type   | string   | 必选                      | 发送的内容类型， 本协议取值 <br />application/json           |
| 3    | accept         | string   | 必选                      | 接受的数据类型类型，本协议取值<br /> application/json        |
| 4    | host           | string   | 必选                      | 请求服务器的域名/IP地址和端口号                              |
| 5    | date           | string   | 必选                      | 消息时间戳，默认标准Gmt表达方式 <br />例如：Date: Tue, 15 Nov 2019 08:12:31 GMT |
| 6    | content-length | long     | 可选                      | 内容长度                                                     |

### 3. 返回码说明

| 返回码      | 说明                                                   |
| ----------- | ------------------------------------------------------ |
| -1          | 系统繁忙                                               |
| -2          | 系统内部异常                                           |
| 0           | 请求成功                                               |
| 20002       | 参数异常                                               |
| 20003       | 请求异常                                               |
| 30001       | 超过日发送数量限制                                     |
| 30002       | 超过月发送数量限制                                     |
| 30003       | 超过每秒 发送数量限制                                  |
| 30004       | 超过年发送数量限制                                     |
| 30006       | 回调接口验证失败                                       |
| 30007       | 审核结果通知发送失败                                   |
| 30008       | chatbotId 与 senderAddress 不匹配                      |
| 40001       | 获取 accessToken 时 appKey 错误，或者 accessToken 无效 |
| 40002       | 不合法的凭证类型                                       |
| 40005       | 不合法的文件类型                                       |
| 40006       | 不合法的文件大小                                       |
| 40007       | 不合法的媒体素材 url                                   |
| 40008       | 不合法的消息类型                                       |
| 40011       | Chatbot 消息跟新失败                                   |
| 40014       | 不合法的 accessToken                                   |
| 40016       | 不合法的按钮个数                                       |
| 40017       | 不合法的按钮类型                                       |
| 40018       | 不合法的按钮名字长度                                   |
| 40019       | 不合法的按钮 KEY 长度                                  |
| 40020       | 不合法的按钮 URL 长度                                  |
| 40021       | 不合法的文本长度                                       |
| 40022       | 临时文件已过期                                         |
| 40040       | 文件数量长处限制                                       |
| 40052       | 不合法的按钮链接                                       |
| 41001       | 缺少 accessToken 参数                                  |
| 41002       | 缺少 appId 参数                                        |
| 41004       | 缺少 appKey 参数                                       |
| 41005       | 缺少多媒体文件数据                                     |
| 41006       | 缺少素材 url 参数                                      |
| 42001       | accessToken 超时                                       |
| 43001       | 需要GET请求                                            |
| 44001       | 多媒体文件为空                                         |
| 44002       | POST 的数据包为空                                      |
| 45001       | 接口调用超过限制                                       |
| 45010       | 回复时间超过限制                                       |
| 46001       | 不存在的用户                                           |
| 46002       | 临时用户不存在                                         |
| 46003       | 用户已被限制                                           |
| 47001       | 解析 JSON/XML 内容错误                                 |
| 47002       | 解析子菜单 JSON/XML 内容错误                           |
| 48001       | api 功能未授权                                         |
| 60001       | 不合法的内容                                           |
| 60002       | 需要订阅关系                                           |
| 60003       | 无效的消息类型                                         |
| 70001       | 消息体被管控                                           |
| 81000~83999 | 中国电信个性返回码                                     |
| 87000~89999 | 中国联通个性返回码                                     |

### 4. 接口频率限制说明

| 接口             | 每日限额 |
| ---------------- | -------- |
| 获取 accessToken | 2000     |
| 验收消息真实性   | 无上限   |
| 接收普通消息     | 无上限   |
| 接收时间推送     | 无上限   |
| 发送被动响应消息 | 无上限   |
| 发送主动客服消息 | 无上限   |

## 三、基础能力接口

### 1. 获取 accessToken

- **接口方向：** Chatbot→5G 消息业务平台 

- **请求方法：**`HTTPS POST `

- **请求URL**：**https://{serverRoot}/bot/{apiVersion}/{chatbotId}/accessToken**

- **接口说明：** accessToken是Chatbot帐号的全局唯一票据，Chatbot账号调用各接口时都需使用 accessToken。正常情况accessToken有效期为7200秒，重复获取将导致上次获取的 accessToken失效。由于获取accessToken的api调用次数非常有限，建议Chatbot全局存储与更 新accessToken，频繁刷新accessToken会导致api调用受限，影响自身业务。 Chatbot账号可以使用appId和appkey调用本接口来获取accessToken。appId和appkey可在 开发模式中获得。注意调用所有5G消息业务平台接口时均需使用https协议。 Chatbot首次获取accessToken成功，则认为Chatbot接入成功，Chatbot接入后，平台需要 进行回调url的验证，验证通过才认为该Chatbot已启用，为可用状态，否则该Chatbot不可用。

- **请求体**

  | 序号 | 字段   | 数据类型 | 可选属性 | 描述                      |
  | ---- | ------ | -------- | -------- | ------------------------- |
  | 1    | appId  | string   | 必选     | 第三方chatbot唯一凭证     |
  | 2    | appKey | string   | 必选     | 第三方chatbot唯一凭证密钥 |

  示例

  ```json
  { 
      "appId": "xxxxxxxx", 
      "appKey": "xxxxxxx" 
  }
  ```

- **返回体**

  | 序号 | 字段         | 数据类型 | 可选属性 | 描述                                        |
  | ---- | ------------ | -------- | -------- | ------------------------------------------- |
  | 1    | accessToken  | string   | 必选     | 获取到的凭证                                |
  | 2    | expires      | int      | 必选     | 凭证有效时间，单位：秒                      |
  | 3    | url          | string   | 必选     | 后续使用接口时调用的服务器地址              |
  | 4    | errorCode    | int      | 必选     | 状态码，0：成功<br />其它状态参见返回码说明 |
  | 5    | errorMessage | string   | 可选     | 错误描述                                    |

  示例

  ```json
  // 正确响应
  { 
      "accessToken": "xxxxxxxx", 
      "expires": 7200, 
      "errorCode":0, 
      "url": "xxxxxx" 
  }
  
  // 错误响应
  { 
      "errorCode": 40013, 
      "errorMessage": "not match rule" 
  }
  ```

### 2. 身份鉴权

- **接口方向：** 5G 消息业务平台 → Chatbot

- **请求方法：** `HTTPS GET` 

- **请求 URL：https://{notifyURL}/notifyPath** 

- **接口说明：** 在Chatbot首次接入时，由平台分配或Chatbot指定随机码token，服务器将发送GET请求 到Chatbot填写的消息接收URL上，并且在请求消息中带上4个参数（signature、timestamp 、 nonce、echoStr），Chatbot须通过对签名（即signature）的效验，来判断此条消息的真实性。

  > **加密/校验流程如下**： 
  >
  > 1、将token、timestamp 、nonce三个参数内容进行字典顺序排序。 
  >
  > 2、将排序后三个参数字符串拼接成字符串并进行sha256摘要加密。 
  >
  > 3、将加密后的字符串与请求消息中的signature对比，判断请求消息来源是否合法。

- **请求头：**

  | 序号 | 字段      | 数据类型 | 可选属性 | 描述                                      |
  | ---- | --------- | -------- | -------- | ----------------------------------------- |
  | 1    | signature | string   | 必选     | 根据加密流程生成的签名                    |
  | 2    | timestamp | long     | 必选     | Linux时间戳，即1970年1月1日以来经过的秒数 |
  | 3    | nonce     | string   | 必选     | 采用UUID算法生成                          |
  | 4    | echoStr   | string   | 可选     | 随机字符串，验证Chatbot消息接收url使用    |
  | 5    | chatbotId | string   | 必选     | ChatbotId                                 |

  > Chatbot首次接入或更换消息接收url时，平台将对消息接收url进行有效性验证，验证通 过则认为该Chatbot为可用状态，否则该Chatbot不可用。
  >
  > Chatbot通过检验signature对请求进 行校验，若Chatbot确认此次请求来自5G消息业务平台服务器，则原样返回请求消息中的 echoStr随机字符串和appId，平台校验是否属实，若平台校验成功，则接入成功，证明url为 有效的url，否则接入失败。 
  >
  > 后续推送消息时，平台将在请求http头域附加signature、timestamp、nonce参数，若确认 此次请求来自5G消息业务平台服务器，则请求有效。

- **响应头：**

  | 序号 | 字段    | 数据类型 | 可选属性 | 描述                                   |
  | ---- | ------- | -------- | -------- | -------------------------------------- |
  | 1    | echoStr | string   | 必选     | 随机字符串，验证Chatbot消息接收url使用 |
  | 2    | appId   | string   | 必选     | 第三方chatbot唯一凭证                  |

## 四、Chatbot 信息管理

> Chatbot选填信息指终端展示的Chatbot信息里面的非必填内容，Chatbot可根据自身情况， 填写和更新信息
>
> Chatbot填写的选填信息每次更新后须经平台审核通过才可使用。

### 1. Chatbot 基本信息

- **接口方向**：Chatbot →5G 消息业务平台 

- **请求方法：** `HTTPS POST` 

- **请求 URL：https://{serverRoot}/bot/{apiVersion}/{chatbotId}/update/chatBotInfo/optionals**

- **接口说明**： 可根据Chatbot自身情况，更新Chatbot的选填基本信息，并通过接口将信息传递给平台， 平台审核通过后，信息生效，可供终端查看

- **请求体：**

  | 序号 | 字段               | 数据类型 | 长度  | 可选属性 | 描述                                                         |
  | ---- | ------------------ | -------- | ----- | -------- | ------------------------------------------------------------ |
  | 1    | serviceDescription | string   | 500   | 可选     | 服务描述:用于解释Chatbot的用 途，最多500个字符               |
  | 2    | category           | Object   | 50*15 | 可选     | 机器人分类，每种分类最长 50 字节。需要携带多个分类时，应 携带多个 category 参数。 最多可携带15个category参数。 （本期暂时只可携带1种分类） |
  | 3    | callBackNumber     | string   | 21    | 可选     | 回拨号码：用于终端用户直接回 拨给 Chatbot 方的电话号码；     |
  | 4    | provider           | string   | 100   | 可选     | 机器人提供者信息                                             |
  | 5    | longitude          | double   | 8     | 可选     | 地理位置经度                                                 |
  | 6    | latitude           | double   | 8     | 可选     | 地理位置纬度                                                 |
  | 7    | themeColour        | string   | 20    | 可选     | 主题颜色：用聊天机器人的用户 的对话视图中应用的主题颜色 （例如，消息气泡和对话标题的 颜色）；填写具体的 RGB 值,如 黑色为：#000000 |
  | 8    | serviceWebsite     | string   | 150   | 可选     | 服务网站：Chatbot 服务方的网站 信息                          |
  | 9    | emailAddress       | string   | 50    | 可选     | 电子邮件：Chatbot 服务方的电子 邮件                          |
  | 10   | backgroundImage    | string   | 150   | 可选     | 应用于聊天机器人信息页面的 背景图像                          |
  | 11   | address            | string   | 200   | 可选     | 营业地址                                                     |
  | 12   | cssStyle           | string   | 150   | 可选     | 指向 Chatbot 富媒体卡片的通用 CSS 文件的 URL。               |
  | 13   | autograph          | string   | 50    | 可选     | 用于消息回落短信时的签名                                     |

  示例：

  ~~~json
  { 
      "callBackNumber": "12345678912", 
      "themeColour": "#000000", 
      "serviceWebsite": "https://xxx.com", 
      "emailAddress": "example@test.com", 
      "backgroundImage": "https://xxxx/xx.png" 
  }
  ~~~

  

- **返回体：**

  | 序号 | 字段         | 数据类型 | 可选属性 | 描述                                        |
  | ---- | ------------ | -------- | -------- | ------------------------------------------- |
  | 1    | errorCode    | int      | 必选     | 状态码，0：成功<br />其它状态参见返回码说明 |
  | 2    | errorMessage | string   | 可选     | 错误描述                                    |

  示例：

  ~~~json
  { 
      "errorCode": 0, 
      "errorMessage": "success" 
  }
  ~~~

### 2. Chatbot 固定菜单

- **接口方向：** Chatbot → 5G 消息业务平台 

- **接口说明：**